# Maintainer: Maxime FRANCK <m@3ko.fr>

pkgname=gitlab-runner
pkgver=0.6.2
pkgrel=0
pkgdesc="GitLab Runner"
url="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner"
arch="x86_64"
license="GPL"
makedepends="git go"
options="!strip"
install=""
source="$pkgname-$pkgver.tar.gz::${url}/repository/archive.tar.gz?ref=v${pkgver}"

_builddir="$srcdir/$pkgname-$pkgver"

prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	export GR_DIR="${_builddir}"
	export GOPATH="${GR_DIR}/Godeps/_workspace"
	cd "${GR_DIR}"
	ln -s "${GR_DIR}" "${GR_DIR}/Godeps/_workspace/src/gitlab.com/gitlab-org/gitlab-ci-multi-runner"
	go get ./...
	go build -v -ldflags -d -o ${GOPATH}/bin/gitlab-ci-multi-runner
}

package() {
	install -v -D -m755 "${GOPATH}/bin/gosu" "${pkgdir}/us/bin/${pkgname}"
	install -v -D -m644 ${_builddir}/LICENSE ${pkgdir}/usr/share/licenses/${pkgname}
}
